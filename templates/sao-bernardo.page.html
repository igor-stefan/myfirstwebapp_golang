{{template "base" .}}

{{define "title"}}
<title class="text-capitalize">Livro - São Bernardo</title>
{{end}}

{{define "css"}}
<link rel="stylesheet" href="/static/css/stylesb.css">
{{end}}

{{define "content"}}
<div class="container">
    <div class="row d-flex mt-2 align-items-center justify-content-center">
        <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12 py-1">
            <img src="/static/images/sao-bernardo.jpg" class="img-fluid cover-image">
        </div>
        <div class="col text-center">
            <h2>Lorem ipsum dolor sit amet. </h2>
            <p class="fst-italic">
                Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                Curabitur elementum sodales eleifend. Morbi eu elementum sapien.
                Aenean at scelerisque ipsum. Pellentesque lobortis sit amet lacus semper mattis.
                Donec ultricies commodo porttitor. Morbi et scelerisque metus, vel tempus urna.
                Vestibulum laoreet, libero eu tincidunt rutrum, lorem ex elementum ligula, ut luctus sem dolor sed
                tortor.
            </p>
            <button id="botao_verf_disponibilidade" class="btn btn-secondary mt-3">Clique aqui!</button>
        </div>
    </div>
</div>
{{end}}

{{define "js"}}

<script>
    //encontra no documento o botao que é o gatilho para abrir a janela de escoher datas
    document.getElementById("botao_verf_disponibilidade").addEventListener("click", function () {
        let html = `
            <form id="form_checar_disponibilidade" action="" method="post" novalidate class="needs-validation m-0">
                <div class="row justify-content-between px-0 mx-0" id="datas_reserva_modal">
                    <div class="col">
                        <div class="input-group mb-0">
                            <input disabled required type="text" id="data_inicio" name="data_inicio" class="form-control" placeholder="Inicio">
                                <span class="input-group-text">
                                    <i class="bi bi-calendar"></i>
                                </span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group mb-0">
                            <input disabled required type="text" id="data_final" name="data_final" class="form-control" placeholder="Final">
                                <span class="input-group-text">
                                    <i class="bi bi-calendar"></i>
                                </span>
                        </div>
                    </div>
                </div>
            </form>  
            `
        alertar.custom({ 
            msg: html, 
            title: "Escolha as datas",
            willOpen: () => {
                    const elem = document.getElementById("datas_reserva_modal");
                    const di = new Date();
                    const dp = new DateRangePicker(elem, {
                        format: "dd/mm/yyyy",
                        showOnFocus: true,
                        autohide: false,
                        minDate: di,
                        todayHighlight: true,

                    })
                    let el = document.getElementById("swal2-html-container");
                    el.style.zIndex = "10000";
                    el.style.overflow = "visible";
                    const startElem = document.getElementById('data_inicio');
                    const endElem = document.getElementById('data_final');
                    startElem.addEventListener('changeDate', function(e) {
                        let df = new Date(e.detail.date)
                        df.setDate(df.getDate() + 7)
                        dp.setOptions({
                            maxDate: df,
                        })
                    }),
                    endElem.addEventListener('changeDate', function(e){
                        let di = new Date(e.detail.date)
                        di.setDate(di.getDate - 7)
                        dp.setOptions({
                            minDate: di,
                        })
                    })
                    startElem.addEventListener('hide', function(e) {
                        let df = new Date(e.detail.date)
                        df.setDate(df.getDate() + 7)
                        endElem.value = df
                    }),
                    endElem.addEventListener('hide', function(e){
                        let di = new Date(e.detail.date)
                        di.setDate(di.getDate - 7)
                        startElem.value = di
                    })
    
                },
                preConfirm: () => {
                    return [
                        document.getElementById('data_inicio').value,
                        document.getElementById('data_final').value
                    ]
                },
                didOpen: () => {
                    document.getElementById("data_inicio").removeAttribute("disabled");
                    document.getElementById("data_final").removeAttribute("disabled");
                },
            callback: function(result){
                console.log("CALLBACK chamado")
                let form = document.getElementById("form_checar_disponibilidade"); //formulario com as datas
                let dados_form = new FormData(form) //adquire os dados do formulario
                dados_form.append("csrf_token","{{ .CSRFToken }}");
                dados_form.append("id_livro", "2");
                fetch("/catalogo-json",{
                    method: "post",
                    body: dados_form
                })
                .then(resposta_fetch => resposta_fetch.json())
                .then(dados_fetch => {
                    if(dados_fetch.ok){
                        let msg = `<p>Livro Disponível!</p>
                        <p><a 
                            href="/reservar-livro?id=${dados_fetch.livroID}&di=${dados_fetch.dataInicio}&df=${dados_fetch.dataFinal}"
                            class="btn btn-primary"> Reservar Agora!
                        </a></p>
                        `
                        alertar.custom({
                            icon: "success",
                            title: "Ótima Notícia!",
                            showConfirmButton: false,
                            msg: msg,
                        })
                    }else{
                        alertar.erro({
                            msg: "Livro indisponível!",
                            icon: "error",
                            text: "Tente outro período",
                            footer: "",
                        })
                    }
            })
            
            }
        });
})
</script>
{{end}}